<!DOCTYPE html>
<html>
<head>
  <title>Display Board - Jungle Queue</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <style>
    body { background: #0b0f19; color: #e6edf3; font-family: 'Segoe UI', sans-serif; }
    .board {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: flex-start;
    }
    .ticket-box {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-width: 160px;
      min-height: 140px;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      text-align: center;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .ticket-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(0,0,0,0.35);
    }

    /* Big centered number */
    .ticket-number {
      font-weight: 800;
      font-size: 2.2rem;
      line-height: 1.1;
      letter-spacing: 0.5px;
    }
    /* Below number: desk info */
    .ticket-sub {
      margin-top: 8px;
      font-size: 0.95rem;
      opacity: 0.95;
    }
    .ticket-meta {
      margin-top: 4px;
      font-size: 0.85rem;
      opacity: 0.8;
    }

    /* Status color-coding */
    .waiting { background: #14213d; color: #9ae6b4; }    /* Waiting in queue */
    .assigned { background: #1b2a4a; color: #63b3ed; }   /* Called, not yet confirmed */
    .serving { background: #2d3748; color: #f6e05e; }    /* Being served */
    .done { display: none; }                              /* Completed: hidden/removed */
    .empty { background: #3b2f2f; color: #f6ad55; }       /* Info boxes */

    /* Blink only for assigned (called) */
    .blink {
      animation: blink 1s infinite;
    }
    @keyframes blink {
      0% { opacity: 1; }
      50% { opacity: 0.35; }
      100% { opacity: 1; }
    }

    /* Section heading */
    .section-title {
      margin: 0 0 12px 4px;
      font-size: 1.05rem;
      opacity: 0.9;
    }

    /* Container */
    .container-frame {
      border: 1px solid #24314f;
      border-radius: 12px;
      padding: 16px;
      min-height: 260px;
      background: rgba(12, 18, 32, 0.6);
    }
  </style>
</head>
<body>
<div class="container py-4">
  <h1 class="h4 mb-3">Display Board</h1>

  <div class="container-frame mb-4">
    <div class="section-title">Active queue</div>
    <div id="messages" class="board"></div>
  </div>

  <div class="container-frame">
    <div class="section-title">Updates</div>
    <div id="updates" class="board"></div>
  </div>
</div>

<script>
const messagesEl = document.getElementById("messages");
const updatesEl = document.getElementById("updates");

// Create or update a ticket box for a given ticket id
function upsertTicketBox({ id, service, status, desk = null, timestamp = null }) {
  const elId = `ticket-${id}`;
  let box = document.getElementById(elId);
  const isNew = !box;

  // If status is "done", remove the element if it exists and return
  if (status === "done") {
    if (box && box.parentNode) box.parentNode.removeChild(box);
    logUpdate(`[${timestamp || "--:--"}] Ticket ${id} for ${prettyService(service)} completed`);
    return;
  }

  if (isNew) {
    box = document.createElement("div");
    box.id = elId;
    box.className = "ticket-box waiting";
    messagesEl.appendChild(box);
  }

  // Reset base class
  box.className = "ticket-box";

  // Apply status styles
  if (status === "waiting") box.classList.add("waiting");
  if (status === "assigned") box.classList.add("assigned", "blink");
  if (status === "serving") box.classList.add("serving");

  // Ensure blink only when assigned
  if (status !== "assigned") box.classList.remove("blink");

  // Content: big number in center + desk info below
  const numberHTML = `<div class="ticket-number">${id}</div>`;
  let subHTML = "";
  if (status === "waiting") {
    subHTML = `<div class="ticket-sub">Waiting • ${prettyService(service)}</div>`;
  } else if (status === "assigned") {
    subHTML = `<div class="ticket-sub">Please proceed to Desk <strong>${desk ?? "—"}</strong></div>
               <div class="ticket-meta">${prettyService(service)}</div>`;
  } else if (status === "serving") {
    subHTML = `<div class="ticket-sub">Now serving at Desk <strong>${desk ?? "—"}</strong></div>
               <div class="ticket-meta">${prettyService(service)}</div>`;
  }

  box.innerHTML = `${numberHTML}${subHTML}`;

  // Keep scroll pinned to bottom on first insert
  if (isNew) messagesEl.scrollTop = messagesEl.scrollHeight;
}

// Log concise updates in the second panel
function logUpdate(text, type = "empty") {
  const row = document.createElement("div");
  row.className = `ticket-box ${type}`;
  row.style.minWidth = "220px";
  row.style.minHeight = "80px";
  row.innerHTML = `<div style="font-size:0.95rem;">${text}</div>`;
  updatesEl.appendChild(row);
  updatesEl.scrollTop = updatesEl.scrollHeight;
}

function prettyService(s) {
  // Capitalize and make user-friendly
  return String(s || "").replace(/_/g, " ").replace(/\b\w/g, ch => ch.toUpperCase());
}

// Bootstrap state from JSON file
fetch("/state")
  .then(res => res.json())
  .then(data => {
    for (const [service, tickets] of Object.entries(data.tickets || {})) {
      tickets.forEach(t => {
        // Do not show completed tickets on boot
        if (t.status !== "done") {
          upsertTicketBox({ id: t.id, service, status: t.status, desk: t.desk || null });
        }
      });
    }
    logUpdate("State loaded from server", "empty");
  });

// Live updates via WebSocket
const clientId = Date.now();
const wsUrl = `ws://${location.host}/ws/${clientId}`;
const ws = new WebSocket(wsUrl);

ws.onmessage = (event) => {
  const data = JSON.parse(event.data);
  const ts = data.timestamp;

  // Normalize server events into statuses and update UI
  if (data.type === "issued") {
    upsertTicketBox({ id: data.ticket, service: data.service, status: "waiting", timestamp: ts });
    logUpdate(`[${ts}] Ticket ${data.ticket} issued for ${prettyService(data.service)}`);
  } else if (data.type === "called") {
    upsertTicketBox({ id: data.ticket, service: data.service, status: "assigned", desk: data.desk, timestamp: ts });
    logUpdate(`[${ts}] Ticket ${data.ticket} → Proceed to Desk ${data.desk} (${prettyService(data.service)})`);
  } else if (data.type === "serving") {
    upsertTicketBox({ id: data.ticket, service: data.service, status: "serving", desk: data.desk, timestamp: ts });
    logUpdate(`[${ts}] Ticket ${data.ticket} now serving at Desk ${data.desk} (${prettyService(data.service)})`);
  } else if (data.type === "done") {
    upsertTicketBox({ id: data.ticket, service: data.service, status: "done", desk: data.desk, timestamp: ts });
  } else if (data.type === "empty") {
    logUpdate(`[${ts}] ${data.message}`, "empty");
  }
};

// Keep-alive ping
setInterval(() => {
  if (ws.readyState === WebSocket.OPEN) {
    ws.send("__ping__");
  }
}, 25000);
</script>

</body>
</html>
